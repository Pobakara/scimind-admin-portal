{% extends "layout.html" %}
{% block title %}Manage Students{% endblock %}
{% block pagetitle %}Manage Students{% endblock %}

{% block content %}
<!-- Bootstrap Nav Tabs -->
<ul class="nav nav-tabs mb-4" id="studentTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="register-tab" data-bs-toggle="tab" data-bs-target="#register" type="button" role="tab" aria-controls="register" aria-selected="true">Register Students</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="attendance-tab" data-bs-toggle="tab" data-bs-target="#attendance" type="button" role="tab" aria-controls="attendance" aria-selected="false">Attendance</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="payments-tab" data-bs-toggle="tab" data-bs-target="#payments" type="button" role="tab" aria-controls="payments" aria-selected="false">Payments</button>
  </li>
</ul>
<div class="tab-content" id="studentTabsContent">
  <div class="tab-pane fade show active" id="register" role="tabpanel" aria-labelledby="register-tab">
    <h2>Register Students</h2>
    <table class="table table-bordered table-striped mt-3">
      <thead>
        <tr>
          <th>Student ID</th>
          <th>Name</th>
          <th>Gender</th>
          <th>Status</th>
          <th>Classes</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="student-table-body">
        {% for student in students %}
        <tr>
          <td>{{ student.student_id }}</td>
          <td>{{ student.first_name }} {{ student.last_name }}</td>
          <td>{{ student.gender }}</td>
          <td>{{ student.status }}</td>
          <td>
            {% if student.class_assignments %}
              {% for ca in student.class_assignments %}
                <div>{{ ca.class_name }} ({{ ca.enrolled_date }})</div>
              {% endfor %}
            {% else %}
              <span class="text-muted">No classes</span>
            {% endif %}
          </td>
          <td style="white-space:nowrap;">
            <a href="{{ url_for('get_student', student_id=student.id) }}" class="btn btn-sm btn-outline-primary" title="Edit Student">‚úèÔ∏è</a>
            {# <a href="{{ url_for('delete_student', student_id=student.id) }}" class="btn btn-sm btn-outline-danger" title="Delete Student" onclick="return confirm('Are you sure you want to delete this student?');">üóëÔ∏è</a> #}
            {# <a href="{{ url_for('assign_class', student_id=student.id) }}" class="btn btn-sm btn-outline-secondary" title="Assign Class">üìå</a> #}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <button class="btn btn-primary mt-3" id="add-student-btn">Add New Student</button>
    <div id="student-form-feedback"></div>
    <form id="add-student-form" class="mt-4" style="display: none;">
      <div class="row">
        <div class="col-md-6">
          <h5>Student Details</h5>
          <div class="mb-3">
            <label for="student-first-name" class="form-label">First Name</label>
            <input type="text" class="form-control" id="student-first-name" name="first_name" required>
          </div>
          <div class="mb-3">
            <label for="student-last-name" class="form-label">Last Name</label>
            <input type="text" class="form-control" id="student-last-name" name="last_name" required>
          </div>
          <div class="mb-3">
            <label for="student-dob" class="form-label">Date of Birth</label>
            <input type="date" class="form-control" id="student-dob" name="dob">
          </div>
          <div class="row mb-3">
            <div class="col-6">
              <label for="student-gender" class="form-label">Gender</label>
              <select class="form-select" id="student-gender" name="gender">
                <option value="">Select</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="col-6">
              <label for="student-status" class="form-label">Status</label>
              <select class="form-select" id="student-status" name="status">
                <option value="Active">Active</option>
                <option value="Inactive">Inactive</option>
              </select>
            </div>
          </div>
          <div class="mb-3">
            <label for="student-email" class="form-label">Student's Email</label>
            <input type="email" class="form-control" id="student-email" name="email">
          </div>
          <div class="mb-3">
            <label for="student-address" class="form-label">Address</label>
            <input type="text" class="form-control" id="student-address" name="address" autocomplete="off">
          </div>
          <div class="mb-3">
            <label for="student-notes" class="form-label">Notes</label>
            <textarea class="form-control" id="student-notes" name="notes" rows="2" autocomplete="off"></textarea>
          </div>
        </div>
        <div class="col-md-6">
          <h5>Parent Details</h5>
          <div class="mb-3">
            <label for="parent-name" class="form-label">Parent Name</label>
            <input type="text" class="form-control" id="parent-name" name="parent_name" autocomplete="off">
          </div>
          <div class="mb-3">
            <label for="parent-relationship" class="form-label">Relationship</label>
            <input type="text" class="form-control" id="parent-relationship" name="parent_relationship" autocomplete="off">
          </div>
          <div class="mb-3">
            <label for="parent-contact" class="form-label">Contact Number</label>
            <input type="text" class="form-control" id="parent-contact" name="parent_contact_number" autocomplete="off">
          </div>
          <div class="mb-3">
            <label for="parent-email" class="form-label">Parent's Email</label>
            <input type="email" class="form-control" id="parent-email" name="parent_email" autocomplete="off">
          </div>
          <hr>
          <h5>Class & Fee Assignment</h5>
          <div class="table-responsive">
            <style>
              .class-fee-action-btn {
                background: none !important;
                border: none;
                box-shadow: none;
                font-family: 'Lucida Sans', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida', Arial, sans-serif;
                font-size: 1.1em;
                padding: 2px 6px;
                color: #333;
                transition: color 0.2s;
              }
              .class-fee-action-btn:hover {
                color: #0d6efd;
                background: none !important;
              }
              .class-fee-select {
                font-family: 'Lucida Sans', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida', Arial, sans-serif;
              }
            </style>
            <table class="table table-bordered align-middle" id="class-fee-assignment-table">
              <thead class="table-light">
                <tr>
                  <th style="width: 36%; min-width: 220px;">Class</th>
                  <th style="width: 110px;">Enrolled Date</th>
                  <th style="width: 350px;">Fee</th>
                  <th style="width: 30px; text-align:center;">Action</th>
                </tr>
              </thead>
              <tbody id="class-fee-assignment-body">
                <tr>
                  <td>
                    <select class="form-select class-select class-fee-select" name="class_code[]" style="min-width:220px; max-width:100%;">
                      <option value="">Select Class</option>
                      {% for c in classes %}
                        <option value="{{ c.code }}">{{ c.class_name }}</option>
                      {% endfor %}
                    </select>
                  </td>
                  <td>
                    <input type="date" class="form-control" name="enrolled_date[]" style="max-width:160px; font-family: 'Lucida Sans', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida', Arial, sans-serif;">
                  </td>
                  <td>
                    <input type="text" class="form-control" name="fee[]" maxlength="300" style="max-width:340px; font-family: 'Lucida Sans', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida', Arial, sans-serif;">
                  </td>
                  <td style="text-align:center; white-space:nowrap; font-size:1.2em;">
                    <span class="assign-class-emoji" title="Assign Class" style="cursor:pointer;">üìå</span>
                    <span class="add-class-fee-emoji" title="Add New Class" style="cursor:pointer;">‚ûï</span>
                    <span class="remove-class-fee-emoji" title="Remove Class" style="cursor:pointer;">üóëÔ∏è</span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="mt-3">
        <button type="submit" class="btn btn-success">Submit</button>
      </div>
    </form>
  </div>
  <div class="tab-pane fade" id="attendance" role="tabpanel" aria-labelledby="attendance-tab">
    <h2>Attendance</h2>
    <p class="text-muted">Feature developing</p>
  </div>
  <div class="tab-pane fade" id="payments" role="tabpanel" aria-labelledby="payments-tab">
    <h2>Payments</h2>
    <p class="text-muted">Feature developing</p>
  </div>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const addBtn = document.getElementById('add-student-btn');
    const form = document.getElementById('add-student-form');
    const feedback = document.getElementById('student-form-feedback');
    addBtn.addEventListener('click', function () {
      form.style.display = form.style.display === 'none' ? 'block' : 'none';
      feedback.innerHTML = '';
    });

    form.addEventListener('submit', async function (e) {
      e.preventDefault();
      feedback.innerHTML = '';

      // Gather form data
      const formData = new FormData(form);
      // Build student data object
      const studentData = {
        first_name: formData.get('first_name'),
        last_name: formData.get('last_name'),
        dob: formData.get('dob'),
        gender: formData.get('gender'),
        status: formData.get('status'),
        email: formData.get('email'),
        address: formData.get('address'),
        notes: formData.get('notes')
      };

      // Parent data (only first parent for now)
      const parentData = {
        name: formData.getAll('parent_name')[0],
        relationship: formData.get('parent_relationship'),
        contact_number: formData.get('parent_contact_number'),
        email: formData.get('parent_email')
      };

      // Class assignments (all rows)
      const classRows = document.querySelectorAll('#class-fee-assignment-body tr');
      const assignments = [];
      classRows.forEach(row => {
        const class_code = row.querySelector('select[name="class_code[]"]').value;
        const enrolled_date = row.querySelector('input[name="enrolled_date[]"]').value;
        if (class_code) {
          assignments.push({ class_code, enrolled_from: enrolled_date });
        }
      });

      try {
        // 1. Add student
        const resp = await fetch('/api/students', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(studentData)
        });
        if (!resp.ok) {
          const err = await resp.json();
          feedback.innerHTML = '<div class="alert alert-danger">Failed to add student: ' + (err.message || 'Unknown error') + '</div>';
          return;
        }
        const student = await resp.json();
        let allSuccess = true;
        let errorMsg = '';

        // 2. Add parent (if name provided)
        if (parentData.name) {
          parentData.student_id = student.id;
          const presp = await fetch('/api/parents', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(parentData)
          });
          if (!presp.ok) {
            allSuccess = false;
            const perr = await presp.json();
            errorMsg += ' Parent not saved: ' + (perr.message || 'Unknown error') + '.';
          }
        }

        // 3. Add class assignments
        for (const a of assignments) {
          a.student_id = student.id;
          const aresp = await fetch('/api/assignments', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(a)
          });
          if (!aresp.ok) {
            allSuccess = false;
            const aerr = await aresp.json();
            errorMsg += ' Class assignment not saved: ' + (aerr.message || 'Unknown error') + '.';
          }
        }

        if (allSuccess) {
          feedback.innerHTML = '<div class="alert alert-success">Student, parent, and class assignments added successfully! ID: ' + student.student_id + '</div>';
        } else {
          feedback.innerHTML = '<div class="alert alert-warning">Student added, but some details failed.' + errorMsg + '</div>';
        }
        form.reset();
        setTimeout(() => {
          form.style.display = 'none';
          feedback.innerHTML = '';
          window.location.reload();
        }, 1500);
      } catch (error) {
        feedback.innerHTML = '<div class="alert alert-danger">Failed to add student: ' + error + '</div>';
      }
    });

    // Add New Class row functionality
    document.getElementById('class-fee-assignment-body').addEventListener('click', function(e) {
      const tbody = document.getElementById('class-fee-assignment-body');
      if (e.target && e.target.classList.contains('add-class-fee-emoji')) {
        const newRow = tbody.rows[0].cloneNode(true);
        // Reset values in the new row
        newRow.querySelectorAll('input, select').forEach(function(input) {
          if (input.tagName === 'SELECT') {
            input.selectedIndex = 0;
          } else {
            input.value = '';
          }
        });
        tbody.appendChild(newRow);
      }
      if (e.target && e.target.classList.contains('remove-class-fee-emoji')) {
        // Only remove if more than one row remains
        if (tbody.rows.length > 1) {
          e.target.closest('tr').remove();
        }
      }
      // Assign class emoji does nothing for now
    });
  });
</script>
{% endblock %}
