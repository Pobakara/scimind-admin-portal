{% extends "layout.html" %}
{% block title %}Manage Classes{% endblock %}
{% block pagetitle %}Manage Classes{% endblock %}

{% block content %}

<!-- ‚úÖ Flash Messages: Lucida Modern Style with Icons -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, msg in messages %}
      {% if msg != 'Invalid username or password' %}
        <div id="toast-message" class="toast-message toast-{{ category }}">
          <span class="toast-icon">
            {% if category == 'success' %}
              <!-- Green check icon -->
              <svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="11" cy="11" r="11" fill="#eafbe7"/><path d="M6 12.5L10 16L16 8" stroke="#2e7d32" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            {% elif category == 'warning' %}
              <!-- Yellow warning icon -->
              <svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="11" cy="11" r="11" fill="#fffbe6"/><path d="M11 6V12" stroke="#bfa100" stroke-width="2.2" stroke-linecap="round"/><circle cx="11" cy="15.2" r="1.2" fill="#bfa100"/></svg>
            {% elif category == 'error' or category == 'danger' %}
              <!-- Red error icon -->
              <svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="11" cy="11" r="11" fill="#ffeaea"/><path d="M7 7L15 15M15 7L7 15" stroke="#d32f2f" stroke-width="2.2" stroke-linecap="round"/></svg>
            {% else %}
              <!-- Info icon -->
              <svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="11" cy="11" r="11" fill="#eaf3fb"/><path d="M11 7V11M11 15H11.01" stroke="#2346a0" stroke-width="2.2" stroke-linecap="round"/></svg>
            {% endif %}
          </span>
          <span class="toast-text">{{ msg }}</span>
          <button onclick="closeToast()" class="toast-close">&times;</button>
        </div>
      {% endif %}
    {% endfor %}
  {% endif %}
{% endwith %}

<!-- üí° Top Bar Actions -->
<div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:24px;">
  <div>
    <button id="add-class-btn" title="Add New Class" style="background:#0b81a2; color:#fff; border:none; border-radius:0; box-shadow:0 4px 18px #0b81a244; font-weight:600; padding:10px 26px 10px 16px; font-size:1.05em; display:inline-flex; align-items:center; gap:10px; transition:background 0.18s, box-shadow 0.18s; cursor:pointer;">
      <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" stroke="#fff" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:8px;"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      Add Class
    </button>
  </div>
  <!-- Removed Bulk Delete and Export CSV buttons -->
</div>

<!-- üîç Search -->
<div style="position:relative; display:inline-block; margin-bottom:18px;">
  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="#0b81a2" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" style="position:absolute; left:12px; top:50%; transform:translateY(-50%); pointer-events:none;"><circle cx="9" cy="9" r="7"/><line x1="16" y1="16" x2="13.5" y2="13.5"/></svg>
  <input type="text" id="class-search" placeholder="Search classes..." style="padding:10px 12px 10px 38px; width:320px; border-radius:0; border:2px solid #0b81a2; font-size:1em; background:#fff; color:#2346a0; box-shadow:0 2px 8px #0b81a233; outline:none; transition:border 0.18s;">
</div>

<div class="manage-classes-flex">
  <!-- Left: Classes Table -->
  <div class="classes-table-panel">
    <div class="table-container">
    <table id="classes-table">
      <thead>
        <tr>
          <th>Class</th>
          <th>Subject</th>
          <th>Year Level</th>
          <th>Batch</th>
          <th>Status</th>
          <th>Linked</th>
        </tr>
      </thead>
      <tbody>
        <!-- Table rows will be rendered by JavaScript -->
      </tbody>
    </table>
  </div>
  <div class="table-footer" id="table-footer"></div>
  </div>
  <!-- Right: Details Panel -->
  <div id="class-details-panel-wrapper" style="position:relative; flex:2 1 480px; min-width:340px; max-width:600px;">
    <div id="class-details-placeholder" style="display:flex; align-items:center; position:absolute; top:0; left:0; height:48px; min-width:260px; color:#888; font-size:1.05em; z-index:2; pointer-events:none; background:transparent; padding-left:8px; padding-top:0; justify-content:flex-start;">&#8592; <span style='margin-left:8px;'>Select a class to view the details</span></div>
    <div id="class-details-panel" class="class-details-panel" style="display:none; background:#fff; border-radius:0; box-shadow:0 2px 18px #0b81a222; padding:36px 32px; min-width:340px; max-width:600px; font-size:1em; position:relative;">
      <div class="details-header-row" style="justify-content: flex-end; position:relative;">
        <div style="display:flex; align-items:center; gap:8px;">
          <!-- 3-dots dropdown trigger -->
          <div class="dropdown-menu-wrapper" style="position:relative;">
            <button id="details-dropdown-btn" class="details-dropdown-btn" title="Actions" style="background:transparent; border:none; cursor:pointer; padding:4px; display:flex; align-items:center;">
              <svg width="26" height="26" viewBox="0 0 26 26" fill="none"><circle cx="13" cy="5.5" r="2" fill="#2346a0"/><circle cx="13" cy="13" r="2" fill="#2346a0"/><circle cx="13" cy="20.5" r="2" fill="#2346a0"/></svg>
            </button>
            <div id="details-dropdown" class="details-dropdown" style="display:none; position:absolute; top:32px; right:0; background:#fff; border:1.5px solid #e3e8f0; border-radius:12px; box-shadow:0 2px 16px rgba(35,70,160,0.10); min-width:180px; z-index:1002;">
              <button class="dropdown-item" id="dropdown-edit-class" style="width:100%; background:none; border:none; padding:12px 18px; text-align:left; font-size:1em; color:#2346a0; cursor:pointer;">‚úçÔ∏è Edit Class</button>
              <button class="dropdown-item" id="dropdown-delete-class" style="width:100%; background:none; border:none; padding:12px 18px; text-align:left; font-size:1em; color:#e74c3c; cursor:pointer;">üóëÔ∏è Delete Class</button>
              <div style="padding:8px 18px; display:flex; align-items:center; gap:10px;">
                <span style="font-size:1em; color:#2346a0;">Active</span>
                <label class="toggle-switch" style="margin-left:auto;">
                  <input type="checkbox" id="dropdown-active-switch">
                  <span class="slider"></span>
                </label>
              </div>
            </div>
          </div>
          <!-- Close pane icon -->
          <button id="close-details-pane-btn" title="Close" style="background:transparent; border:none; cursor:pointer; padding:4px; display:flex; align-items:center;">
            <svg width="26" height="26" viewBox="0 0 26 26" fill="none"><line x1="7" y1="7" x2="19" y2="19" stroke="#2346a0" stroke-width="2.2" stroke-linecap="round"/><line x1="19" y1="7" x2="7" y2="19" stroke="#2346a0" stroke-width="2.2" stroke-linecap="round"/></svg>
          </button>
        </div>
      </div>
      <!-- ...existing details content will be rendered here by JS... -->
    </div>
<style>
.details-dropdown {
  min-width: 180px;
  background: #fff;
  border: 1.5px solid #e3e8f0;
  border-radius: 12px;
  box-shadow: 0 2px 16px rgba(35,70,160,0.10);
  padding: 0;
  z-index: 1002;
}
.details-dropdown .dropdown-item {
  width: 100%;
  background: none;
  border: none;
  padding: 12px 18px;
  text-align: left;
  font-size: 1em;
  color: #2346a0;
  cursor: pointer;
  transition: background 0.15s;
}
.details-dropdown .dropdown-item:hover {
  background: #f7fafd;
}
.details-dropdown .dropdown-item:active {
  background: #e3e8f0;
}
</style>
<script>
// Dropdown menu logic
const dropdownBtn = document.getElementById('details-dropdown-btn');
const dropdownMenu = document.getElementById('details-dropdown');
if (dropdownBtn && dropdownMenu) {
  dropdownBtn.onclick = function(e) {
    e.stopPropagation();
    dropdownMenu.style.display = dropdownMenu.style.display === 'block' ? 'none' : 'block';
  };
  // Hide dropdown when clicking outside
  document.addEventListener('click', function(e) {
    if (!dropdownMenu.contains(e.target) && e.target !== dropdownBtn) {
      dropdownMenu.style.display = 'none';
    }
  });
}
// Close pane logic
const closeDetailsBtn = document.getElementById('close-details-pane-btn');
const detailsPanel = document.getElementById('class-details-panel');
if (closeDetailsBtn && detailsPanel) {
  closeDetailsBtn.onclick = function() {
    detailsPanel.style.display = 'none';
    document.getElementById('class-details-placeholder').style.display = 'flex';
  };
}
// You will need to connect the dropdown actions (edit, delete, active switch) to your JS logic for class actions.
</script>
  </div>
</div>

<!-- Modal Overlay for background gray-out -->
<div id="modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(60,70,90,0.18); z-index:998;"></div>
<!-- ‚ûï Add Class Modal (hidden by default) -->
<div id="add-class-modal" style="display:none; position:fixed; top:10%; left:50%; transform:translateX(-50%); z-index:999;">
  <div class="modal-content" style="border-radius:16px; background:#fff;">
    <div style="font-size:1.5em; font-weight:700; color:#2346a0; margin-bottom:18px; text-align:left; padding-top:0; margin-top:28px; padding-left:36px;">‚ûï Add New Class</div>
    <form method="POST" action="{{ url_for('add_class') }}">
      <div class="modal-form-flex">
        <div class="modal-form-col">
          <label>Subject:</label>
          <input type="text" name="subject" required aria-label="Subject">
          <label>Year Level:</label>
          <input type="text" name="year_level" required placeholder="e.g. Year 10" aria-label="Year Level">
          <label>Batch:</label>
          <input type="text" name="batch" required placeholder="e.g. 2025" aria-label="Batch">
          <label>Sub Batch:</label>
          <input type="text" name="sub_batch" placeholder="e.g. Group 2" aria-label="Sub Batch">
          <label>Class Type:</label>
          <select name="class_type" required aria-label="Class Type">
            <option value="" disabled selected>Select class type</option>
            <option value="Group">Group</option>
            <option value="Individual">Individual</option>
            <option value="Other">Other</option>
          </select>
          <label>Class Description (optional):</label>
          <textarea name="description" rows="2" aria-label="Class Description"></textarea>
        </div>
        <div class="modal-form-col">
          <label>Teacher:</label>
          <select name="class_teacher" aria-label="Teacher" required>
            <option value="" disabled selected>Select teacher</option>
            <option value="Nisa Bandarayapa">Nisa Bandarayapa</option>
          </select>
          <label>Day of Week:</label>
          <select name="class_day" aria-label="Class Day" required>
            <option value="" disabled selected>Select day</option>
            <option value="Monday">Monday</option>
            <option value="Tuesday">Tuesday</option>
            <option value="Wednesday">Wednesday</option>
            <option value="Thursday">Thursday</option>
            <option value="Friday">Friday</option>
            <option value="Saturday">Saturday</option>
            <option value="Sunday">Sunday</option>
          </select>
          <label>Class Time:</label>
          <input type="time" name="class_time" aria-label="Class Time">
          <label>Class Location:</label>
          <input type="text" name="class_location" aria-label="Class Location">
          <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
            <input type="checkbox" id="create_classroom" name="create_classroom" style="vertical-align: middle; margin-bottom: 0;">
            <label for="create_classroom" style="margin-bottom: 0; vertical-align: middle; display: flex; align-items: center;">Create Google Classroom</label>
          </div>
          <div id="gclass_fields" style="display:none; margin-top:10px;">
            <label>Google Classroom Name (required):</label>
            <input type="text" name="gclass_name" id="gclass_name">
            <label>Section (optional):</label>
            <input type="text" name="gclass_section" placeholder="e.g. VCE, Secondary, JMSS">
          </div>
        </div>
      </div>
      <div style="margin-top:18px;">
        <button type="submit" class="btn btn-primary">Create Class</button>
        <button type="button" onclick="closeAddClassModal()" style="background:#fff; color:#0b81a2; border-radius:0; box-shadow:0 2px 8px #0b81a233; border:2px solid #0b81a2; font-weight:600; padding:12px 28px; font-size:16px; margin-left:8px;">Cancel</button>
      </div>
    </form>
  </div>
</div>
<div id="edit-class-modal" style="display:none; position:fixed; top:10%; left:50%; transform:translateX(-50%); z-index:999;">
  <div class="modal-content" style="border-radius:16px; background:#fff;">
    <h3 style="font-size:1.5em; font-weight:700; color:#2346a0; margin-bottom:18px; text-align:left; padding-top:0; margin-top:28px; padding-left:36px;">‚úçÔ∏è Edit Class</h3>
    <form id="edit-class-form">
      <div class="modal-form-flex">
        <div class="modal-form-col">
          <label>Subject:</label>
          <input type="text" name="subject" id="edit-subject" required>
          <label>Year Level:</label>
          <input type="text" name="year_level" id="edit-year-level" required>
          <label>Batch:</label>
          <input type="text" name="batch" id="edit-batch" required>
          <label>Sub Batch:</label>
          <input type="text" name="sub_batch" id="edit-sub-batch" placeholder="e.g. Group 2">
          <label>Class Type:</label>
          <select name="class_type" id="edit-class-type" required>
            <option value="" disabled>Select class type</option>
            <option value="Group">Group</option>
            <option value="Individual">Individual</option>
            <option value="Other">Other</option>
          </select>
          <label>Description:</label>
          <textarea name="description" id="edit-description" rows="2"></textarea>
        </div>
        <div class="modal-form-col">
          <label>Teacher:</label>
          <select name="teacher" id="edit-teacher" required>
            <option value="" disabled>Select teacher</option>
            <option value="Nisa Bandarayapa">Nisa Bandarayapa</option>
          </select>
          <label>Day of Week:</label>
          <select name="class_day" id="edit-class-day" required>
            <option value="" disabled>Select day</option>
            <option value="Monday">Monday</option>
            <option value="Tuesday">Tuesday</option>
            <option value="Wednesday">Wednesday</option>
            <option value="Thursday">Thursday</option>
            <option value="Friday">Friday</option>
            <option value="Saturday">Saturday</option>
            <option value="Sunday">Sunday</option>
          </select>
          <label>Class Time:</label>
          <input type="time" name="class_time" id="edit-class-time">
          <label>Class Location:</label>
          <input type="text" name="class_location" id="edit-class-location">
        </div>
      </div>
      <div style="margin-top:18px;">
        <button type="submit" class="btn btn-primary">Save Changes</button>
        <button type="button" class="btn" style="background:#fff; color:#0b81a2; border-radius:0; box-shadow:0 2px 8px #0b81a233; border:2px solid #0b81a2; font-weight:600; padding:12px 28px; font-size:16px; margin-left:8px;" onclick="closeEditClassModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>
<!-- üéì Google Classroom Link Modal (hidden by default) -->
<div id="gclass-link-modal" style="display:none; position:fixed; top:12%; left:50%; transform:translateX(-50%); z-index:999;">
  <div class="modal-content gclass-link-modal-content" style="border-radius:16px; background:#fff; min-width:400px; max-width:520px;">
<div style="font-size:1.15em; font-weight:700; color:#2346a0; margin-bottom:18px; text-align:left; padding-top:0; margin-top:28px; padding-left:36px;">üìö Link to Google Classroom</div>
    <form id="gclass-link-form">
      <label>Google Classroom Name:</label>
      <input type="text" name="gclass_name" id="gclass-link-name" required>
      <label>Section (optional):</label>
      <input type="text" name="gclass_section" id="gclass-link-section" placeholder="e.g. VCE, Secondary, JMSS">
      <div style="margin-top:18px;">
        <button type="submit" class="btn btn-primary">Create & Link</button>
        <button type="button" class="btn" style="background:#fff; color:#0b81a2; border-radius:0; box-shadow:0 2px 8px #0b81a233; border:2px solid #0b81a2; font-weight:600; padding:12px 28px; font-size:16px; margin-left:8px;" onclick="closeGClassModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>



<!-- üßº Styling -->
<style>
/* Two-column modal form layout */
.modal-content {
  width: 90vw;
  max-width: 1200px;
  min-width: 600px;
  min-height: 500px;
  height: auto;
  margin: 0 auto;
  background: #fff;
  border-radius: 16px;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  gap: 18px;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 0;
  box-shadow: 0 2px 24px rgba(35,70,160,0.18);
}
/* Modern Add Class button */
/* Modern Add Class button - compact */
.add-class-modern-btn {
  background: #2346a0;
  color: #fff;
  border: none;
  border-radius: 28px;
  padding: 8px 18px 8px 14px;
  font-size: 0.98em;
  font-weight: 600;
  box-shadow: 0 2px 12px rgba(35,70,160,0.10);
  display: flex;
  align-items: center;
  gap: 6px;
  transition: background 0.18s, box-shadow 0.18s;
  cursor: pointer;
}
.add-class-modern-btn:hover, .add-class-modern-btn:focus {
  background: #18316d;
  box-shadow: 0 4px 18px rgba(35,70,160,0.16);
  outline: none;
}
/* Details pane action buttons */
.details-action-btn {
  background: #2346a0;
  color: #fff;
  border: none;
  border-radius: 24px;
  padding: 6px 14px;
  font-size: 1em;
  font-weight: 600;
  box-shadow: 0 2px 8px rgba(35,70,160,0.08);
  display: flex;
  align-items: center;
  transition: background 0.18s, box-shadow 0.18s;
  cursor: pointer;
}
.details-action-btn:hover, .details-action-btn:focus {
  background: #18316d;
  box-shadow: 0 4px 12px rgba(35,70,160,0.14);
  outline: none;
}
/* Toggle switch for status */
.toggle-switch {
  position: relative;
  display: inline-block;
  width: 38px;
  height: 22px;
  vertical-align: middle;
}
.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}
.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #e3e8f0;
  border-radius: 22px;
  transition: background 0.3s;
}
.slider:before {
  position: absolute;
  content: "";
  height: 16px;
  width: 16px;
  left: 3px;
  top: 3px;
  background-color: #fff;
  border-radius: 50%;
  box-shadow: 0 2px 6px rgba(35,70,160,0.10);
  transition: transform 0.3s;
}
.toggle-switch input:checked + .slider {
  background-color: #1ed760;
}
.toggle-switch input:checked + .slider:before {
  transform: translateX(16px);
}

/* Details header row for details pane */
.details-header-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
  gap: 10px;
}
.details-header-main {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  flex-wrap: nowrap;
  min-width: 0;
  position: relative;
}
.details-title {
  font-size: 1.18em;
  font-weight: 700;
  color: #0b81a2;
  white-space: nowrap;
  line-height: 1;
}
.status-label {
  font-size: 0.98em;
  font-weight: 600;
  line-height: 1;
  margin-left: 2px;
}
.status-label.active {
  color: #1ed760;
}
.status-label.inactive {
  color: #e74c3c;
}
.details-header-actions {
  display: flex;
  gap: 10px;
  align-items: center;
  height: 32px;
}
.details-action-btn.edit {
  background: transparent;
  color: #0b81a2;
  border: none;
  border-radius: 0;
  box-shadow: none;
  padding: 6px;
  font-size: 1.1em;
  display: flex;
  align-items: center;
  cursor: pointer;
  height: 32px;
}
.details-action-btn.delete {
  background: transparent;
  color: #e74c3c;
  border: none;
  border-radius: 0;
  box-shadow: none;
  padding: 6px;
  font-size: 1.1em;
  display: flex;
  align-items: center;
  cursor: pointer;
  height: 32px;
}
.details-action-btn.close {
  background: transparent;
  color: #0b81a2;
  border: none;
  border-radius: 0;
  box-shadow: none;
  padding: 6px;
  font-size: 1.1em;
  display: flex;
  align-items: center;
  cursor: pointer;
  height: 32px;
}
.modal-form-flex {
  display: flex;
  flex-direction: row;
  gap: 48px;
  flex-wrap: nowrap;
  width: 100%;
  min-width: 0;
  justify-content: stretch;
  align-items: flex-start;
}
.modal-form-col {
  flex: 1 1 0;
  min-width: 320px;
  max-width: 520px;
  display: flex;
  flex-direction: column;
  gap: 18px;
  /* Removed duplicate padding-bottom to avoid double padding in forms */
}
/* --- Lucida Modern Toast Styles --- */
.toast-message {
  position: fixed;
  top: 32px;
  right: 32px;
  min-width: 320px;
  max-width: 420px;
  font-family: 'Lucida Sans', 'Lucida Grande', 'Lucida Sans Unicode', Arial, sans-serif;
  font-size: 1.08em;
  font-weight: 500;
  border-radius: 14px;
  box-shadow: 0 2px 16px rgba(35,70,160,0.10);
  z-index: 9999;
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 16px 28px 16px 18px;
  animation: fadein 0.4s;
  border: 1.5px solid #e3e8f0;
  letter-spacing: 0.01em;
}
.toast-message .toast-icon {
  display: flex;
  align-items: center;
  margin-right: 6px;
}
.toast-message .toast-text {
  flex: 1 1 auto;
  font-size: 1.08em;
  font-family: 'Lucida Sans', 'Lucida Grande', 'Lucida Sans Unicode', Arial, sans-serif;
  color: #2346a0;
}
.toast-message.toast-success {
  background: #eafbe7;
  color: #2e7d32;
  border-color: #b6e2b3;
}
.toast-message.toast-warning {
  background: #fffbe6;
  color: #bfa100;
  border-color: #ffe066;
}
.toast-message.toast-error, .toast-message.toast-danger {
  background: #ffeaea;
  color: #d32f2f;
  border-color: #ffbdbd;
}
.toast-message.toast-info {
  background: #eaf3fb;
  color: #2346a0;
  border-color: #b6d6f2;
}
.toast-close {
  background: none;
  border: none;
  font-size: 1.5em;
  color: #2346a0;
  cursor: pointer;
  margin-left: 12px;
  font-family: inherit;
  transition: color 0.18s;
}
.toast-close:hover {
  color: #d32f2f;
}
@keyframes fadein {
  from { opacity: 0; transform: translateY(-20px);}
  to { opacity: 1; transform: translateY(0);}
}
body {
  width: 100vw;
  min-height: 100vh;
  margin: 0;
  background: #f7fafd;
}
.container, .content, main {
  width: 100%;
  max-width: 100vw;
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}
.manage-classes-flex {
  display: flex;
  gap: 32px;
  margin-top: 24px;
}
.classes-table-panel {
  flex: 1 1 900px;
  max-width: 900px;
  display: flex;
  flex-direction: column;
}
#classes-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  background: #fff;
      min-width: 600px;
      table-layout: auto;
}
#classes-table thead, #classes-table tfoot {
  background: #f7fafd;
  z-index: 2;
}
#classes-table th, #classes-table td {
  padding: 16px 12px;
  border-bottom: 1px solid #e9ecf3;
  text-align: center;
  line-height: 1.7;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  border-radius: 0;
}
#classes-table th {
  position: sticky;
  top: 0;
  z-index: 2;
  box-shadow: 0 2px 2px -2px #e9ecf3;
  background: #f7fafd;
  font-weight: 700;
  color: #2346a0;
  border-radius: 0;
}

#classes-table tbody {
  display: block;
  max-height: 400px; /* Adjust as needed */
  overflow-y: auto;
  width: 100%;
}
#classes-table thead, #classes-table tfoot {
  display: table;
  width: 100%;
  table-layout: fixed;
}
#classes-table tr {
  display: table;
  width: 100%;
  table-layout: fixed;
}
.class-row:hover {
  background: #f7fafd;
  cursor: pointer;
}
.class-name-link {
  color: #2346a0;
  text-decoration: underline;
  font-weight: 600;
  cursor: pointer;
}
.linked-symbol {
  color: #1ed760;
  font-size: 1.2em;
}
.class-details-panel {
  flex: 3 1 800px;
  background: #f9fbfd;
  border-radius: 16px;
  padding: 44px 44px;
  min-width: 6000px;
  max-width: 1300px;
  font-size: 0.95em;
  line-height: 1.6;
  display: flex;
  flex-direction: column;
  gap: 0;
  transition: box-shadow 0.2s;
  min-height: 540px;
  max-height: 90vh;
  overflow-y: auto;  
}

.class-details-panel.active {
  box-shadow: 0 2px 24px rgba(35,70,160,0.10);
  background: #fff;
}

.details-section {
  margin-bottom: 28px;
  padding-bottom: 14px;
  border-bottom: 1.5px solid #e3e8f0;
}


.details-section:last-child {
  border-bottom: none;
}

.details-section-title {
  font-weight: 700;
  color: #2346a0;
  margin-bottom: 6px;
  font-size: 1em;
  letter-spacing: 0.01em;
}
.details-section > div {
  margin-bottom: 3px;
}
.details-section > div:last-child {
  margin-bottom: 0;
}
@media (max-width: 1300px) {
  .modal-content {
    max-width: 98vw;
    min-width: 0;
    width: 98vw;
    overflow-x: auto;
  }
  .modal-form-flex {
    flex-direction: column;
    gap: 18px;
    min-width: 0;
  }
  .modal-form-col {
    min-width: 0;
    max-width: 100vw;
  }
}
@media (max-width: 900px) {
  .manage-classes-flex {
    flex-direction: column;
    gap: 18px;    
  }
  .class-details-panel {
    max-width: 98vw;
    min-width: 90vw;
    padding: 18px 8px;
    margin-top: 12px;
  }
  .table-container {
    max-width: 100vw;
    min-width: 0;
    overflow-x: auto;
  }
  #classes-table {
    min-width: 520px;
    width: 100%;
    table-layout: auto;
  }
}
.class-name {
  font-size: 1.15em;
  font-weight: 600;
  color: #2346a0;
  text-decoration: underline;
  cursor: pointer;
}
.class-meta {
  margin-top: 6px;
  font-size: 0.98em;
  color: #444;
  display: flex;
  gap: 12px;
  align-items: center;
}
.linked-symbol {
  color: #1ed760;
  font-size: 1.2em;
}
.details-header {
  font-size: 1em;
  font-weight: 600;
  margin-bottom: 6px;
}
.details-tabs {
  display: flex;
  gap: 12px;
}
.details-tab {
  background: #f7fafd;
  color: #2346a0;
  border: 1px solid #dbe3f0;
  border-radius: 18px;
  font-size: 1em;
  font-weight: 600;
  padding: 8px 22px;
  cursor: pointer;
  transition: background 0.18s, color 0.18s, border 0.18s;
}
.details-tab.active,
.details-tab:focus {
  background: #2346a0;
  color: #fff;
  border-color: #2346a0;
  outline: none;
}
.details-tab:hover {
  background: #e9ecf3;
  color: #18316d;
  border-color: #b0c4de;
}
.details-content {
  margin-top: 12px;
}
.details-actions {
  display: flex;
  gap: 16px;
  margin-top: 24px;
}
/* Remove padding from modal, only handle background and border */
.modal {
  position: fixed;
  top: 10%;
  left: 50%;
  transform: translateX(-50%);
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 2px 24px rgba(35,70,160,0.18);
  max-width: 760px;
  min-width: 520px;
  z-index: 999;
}
/* Default modal-content for large modals - remove padding, let form handle it */


/* Smaller modal for Google Classroom link - remove padding, let form handle it */
.gclass-link-modal-content {
  width: 100%;
  max-width: 520px;
  min-width: 400px;
  min-height: unset;
  height: unset;
  margin: 0 auto;
  background: #fff;
  border-radius: 16px;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  gap: 18px;
  overflow-y: auto;
  box-shadow: none;
}
/* Add padding to the form and titles inside modals for clarity */
.modal-content form,
.gclass-link-modal-content form {
  padding: 28px 36px 28px 36px;
  box-sizing: border-box;
  width: 100%;
}
.modal-content h2, .modal-content h3,
.gclass-link-modal-content h2, .gclass-link-modal-content h3 {
  padding: 0 36px;
  margin-top: 24px;
  margin-bottom: 18px;
}
.modal-content label,
.gclass-link-modal-content label {
  font-weight: 500;
  margin-bottom: 2px;
  color: #2346a0;
}
.modal-content input[type="text"],
.modal-content textarea,
.gclass-link-modal-content input[type="text"],
.gclass-link-modal-content textarea {
  padding: 10px 14px;
  border-radius: 6px;
  border: 1px solid #dbe3f0;
  font-size: 1em;
  margin-bottom: 4px;
  width: 100%;
  box-sizing: border-box;
}
#add-class-modal .btn {
  min-width: 110px;
  border-radius: 0;
  background: #0b81a2;
  color: #fff;
  box-shadow: 0 2px 8px rgba(0,0,0,0.18);
  border: none;
  font-weight: 600;
  transition: box-shadow 0.2s, background 0.2s;
}

#add-class-modal .btn:hover, #add-class-modal .btn:focus {
  background: #096b87;
  box-shadow: 0 4px 16px rgba(0,0,0,0.22);
}
@media (max-width: 700px) {
  .class-grid {
    flex-direction: column;
    gap: 12px;
  }
  .class-card {
    min-width: 90vw;
    max-width: 98vw;
    padding: 12px 8px;
  }
  .class-details-panel, .modal {
    max-width: 98vw;
    min-width: 90vw;
    padding: 18px 8px;
  }
}
.status-indicator {
  display: inline-block;
  padding: 2px 12px;
  border-radius: 12px;
  font-size: 0.98em;
  font-weight: 600;
  color: #fff;
}
.status-indicator.active {
  background: #1ed760;
}
.status-indicator.inactive {
  background: #e74c3c;
}
.btn-sm {
  font-size: 0.95em;
  padding: 6px 16px;
  border-radius: 18px;
}
.table-container {
  flex: 1 1 auto;
  min-width: 800px;
  max-width: 900px;
  max-height: 480px;
  overflow: hidden;
  background: #fff;
  border-radius: 12px 12px 0 0;
  position: relative;
  display: flex;
  flex-direction: column;
}
.table-footer {
  background: #0b81a2;
  color: #fff;
  font-weight: 500;
  padding: 12px 18px;
  border-radius: 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 1em;
  position: sticky;
  bottom: 0;
  z-index: 3;
}
.table-footer .page-btn {
  background: #fff;
  color: #2346a0;
  border: none;
  border-radius: 6px;
  padding: 2px 10px;
  margin: 0 2px;
  cursor: pointer;
  font-weight: 600;
  font-size: 1em;
  transition: background 0.15s;
}
.table-footer .page-btn.active,
.table-footer .page-btn:hover {
  background: #dbe3f0;
}
</style>

<!-- ‚úÖ JS Logic -->
<script>
// @ts-ignore
const classData = {{ classes | tojson | safe }};
let selectedClassCode = null;

// --- Fix: Add missing closeAllModals function ---
function closeAllModals() {
  // Hide all modals and overlay
  const modals = [
    document.getElementById('add-class-modal'),
    document.getElementById('edit-class-modal'),
    document.getElementById('gclass-link-modal')
  ];
  modals.forEach(m => { if (m) m.style.display = 'none'; });
  const overlay = document.getElementById('modal-overlay');
  if (overlay) overlay.style.display = 'none';
}

function generateClassCode(subject, yearLevel, batch, subBatch, classType) {
  // Example: Science, Year 8, 2025, Group 1, Group -> SCI82025GROUP1G
  const subj = subject.replace(/\s+/g, '');
  const codeSubj = subj.substring(0,3).toUpperCase();
  let year = '';
  const yearMatch = yearLevel.match(/\d+/);
  if (yearMatch) {
    year = yearMatch[0]; // Use digit as-is, no padding
  }
  const batchStr = batch.trim();
  const subBatchStr = subBatch ? subBatch.replace(/\s+/g, '').toUpperCase() : '';
  const classTypeLetter = classType ? classType.trim().charAt(0).toUpperCase() : '';
  return `${codeSubj}${year}${batchStr}${subBatchStr}${classTypeLetter}`;
}
function getClassName(subject, yearLevel, batch, subBatch) {
  // Science - Year 8 - 2025 - Group 1 (if subBatch exists)
  let name = `${subject} - ${yearLevel} - ${batch}`;
  if (subBatch && subBatch.trim()) {
    name += ` - ${subBatch.trim()}`;
  }
  return name;
}

// Show Add Class Modal
document.getElementById("add-class-btn").onclick = function() {
  closeAllModals();
  document.getElementById("add-class-modal").style.display = "block";
  document.getElementById("modal-overlay").style.display = "block";
  // Autofill class code preview if needed
  const subject = document.querySelector('input[name="subject"]').value;
  const yearLevel = document.querySelector('input[name="year_level"]').value;
  const batch = document.querySelector('input[name="batch"]').value;
  const subBatch = document.querySelector('input[name="sub_batch"]').value;
  const classType = document.querySelector('select[name="class_type"]').value;
  // You can show preview if you want
};

function closeAddClassModal() {
  document.getElementById("add-class-modal").style.display = "none";
  document.getElementById("modal-overlay").style.display = "none";
}

// Show/hide Google Classroom fields and autofill name
document.getElementById("create_classroom").addEventListener("change", function() {
  const gFields = document.getElementById("gclass_fields");
  gFields.style.display = this.checked ? "block" : "none";
  if (this.checked) {
    const subject = document.querySelector('input[name="subject"]').value;
    const yearLevel = document.querySelector('input[name="year_level"]').value;
    const batch = document.querySelector('input[name="batch"]').value;
    const subBatch = document.querySelector('input[name="sub_batch"]').value;
    const className = getClassName(subject, yearLevel, batch, subBatch);
    document.getElementById("gclass_name").value = className;
  }
});

// Update Google Classroom name live as fields change
["subject", "year_level", "batch", "sub_batch"].forEach(name => {
  document.querySelector(`input[name="${name}"]`).addEventListener("input", function() {
    if (document.getElementById("create_classroom").checked) {
      const subject = document.querySelector('input[name="subject"]').value;
      const yearLevel = document.querySelector('input[name="year_level"]').value;
      const batch = document.querySelector('input[name="batch"]').value;
      const subBatch = document.querySelector('input[name="sub_batch"]').value;
      const className = getClassName(subject, yearLevel, batch, subBatch);
      document.getElementById("gclass_name").value = className;
    }
  });
});

// --- Update class code preview on input ---
["subject", "year_level", "batch", "sub_batch"].forEach(name => {
  document.querySelector(`input[name="${name}"]`).addEventListener("input", function() {
    const subject = document.querySelector('input[name="subject"]').value;
    const yearLevel = document.querySelector('input[name="year_level"]').value;
    const batch = document.querySelector('input[name="batch"]').value;
    const subBatch = document.querySelector('input[name="sub_batch"]').value;
    const classType = document.querySelector('select[name="class_type"]').value;
    const code = generateClassCode(subject, yearLevel, batch, subBatch, classType);
    // You can show preview if you want
  });
});
document.querySelector('select[name="class_type"]').addEventListener("change", function() {
  const subject = document.querySelector('input[name="subject"]').value;
  const yearLevel = document.querySelector('input[name="year_level"]').value;
  const batch = document.querySelector('input[name="batch"]').value;
  const subBatch = document.querySelector('input[name="sub_batch"]').value;
  const classType = document.querySelector('select[name="class_type"]').value;
  const code = generateClassCode(subject, yearLevel, batch, subBatch, classType);
  // You can show preview if you want
});

// Show Details Panel
function showClassDetails(code) {
  selectedClassCode = code;
  const data = classData[code];
  const panel = document.getElementById("class-details-panel");
  const placeholder = document.getElementById("class-details-placeholder");
  panel.classList.add("active");
  panel.style.display = "block";
  if (placeholder) placeholder.style.display = "none";
  const isActive = data.active !== false; // default true if not set
  const className = data.class_name || getClassName(data.subject, data.year_level, data.batch, data.sub_batch);
  panel.innerHTML = `
    <div class="details-header-row" style="justify-content: flex-end; position:relative; margin-bottom:18px;">
      <div style="display:flex; align-items:center; gap:8px; width:100%; justify-content:space-between;">
        <div style="display:flex; flex-direction:column; gap:2px; min-width:0;">
          <span class="details-title" style="font-family:'Lucida Sans', 'Lucida Grande', 'Lucida Sans Unicode', Arial, sans-serif; font-size:1.18em; font-weight:700; color:#2346a0;">${className}</span>
          <span class="class-code-subtitle" style="color:#888; font-size:0.98em; font-weight:500;">${code}</span>
        </div>
        <div style="display:flex; align-items:center; gap:8px;">
          <div class="dropdown-menu-wrapper" style="position:relative;">
            <button id="details-dropdown-btn" class="details-dropdown-btn" title="Actions" style="background:transparent; border:none; cursor:pointer; padding:4px; display:flex; align-items:center; border-radius:8px; transition:background 0.15s;">
              <svg width="26" height="26" viewBox="0 0 26 26" fill="none"><circle cx="13" cy="5.5" r="2" fill="#2346a0"/><circle cx="13" cy="13" r="2" fill="#2346a0"/><circle cx="13" cy="20.5" r="2" fill="#2346a0"/></svg>
            </button>
            <div id="details-dropdown" class="details-dropdown" style="display:none; position:absolute; top:32px; right:0; background:#fff; border:1.5px solid #e3e8f0; border-radius:14px; box-shadow:0 2px 16px rgba(35,70,160,0.10); min-width:200px; z-index:1002; font-family:'Lucida Sans', 'Lucida Grande', 'Lucida Sans Unicode', Arial, sans-serif;">
              <button class="dropdown-item" id="dropdown-edit-class" style="width:100%; background:none; border:none; padding:14px 22px; text-align:left; font-size:1.08em; color:#2346a0; cursor:pointer; display:flex; align-items:center; gap:10px;">
                <span style="font-size:1.18em;">‚úçÔ∏è</span> <span>Edit Class</span>
              </button>
              <button class="dropdown-item" id="dropdown-delete-class" style="width:100%; background:none; border:none; padding:14px 22px; text-align:left; font-size:1.08em; color:#e74c3c; cursor:pointer; display:flex; align-items:center; gap:10px;">
                <span style="font-size:1.18em;">üóëÔ∏è</span> <span>Delete Class</span>
              </button>
              <div style="padding:10px 22px; display:flex; align-items:center; gap:12px; border-top:1px solid #e3e8f0;">
                <span style="font-size:1.08em; color:#2346a0;">Active</span>
                <label class="toggle-switch" style="margin-left:auto;">
                  <input type="checkbox" id="dropdown-active-switch" ${isActive ? 'checked' : ''}>
                  <span class="slider"></span>
                </label>
              </div>
            </div>
          </div>
          <button id="close-details-pane-btn" title="Close" style="background:transparent; border:none; cursor:pointer; padding:0; margin-left:0; display:flex; align-items:center; border-radius:50%; transition:background 0.15s; width:50px; height:50px; min-width:50px; min-height:50px; justify-content:center; overflow:visible;">
            <svg width="26" height="26" viewBox="0 0 26 26" fill="none" style="display:block; overflow:visible;"><rect x="10" y="17" width="20" height="3" rx="1.5" transform="rotate(-45 10 17)" fill="#2346a0"/><rect x="13" y="10" width="20" height="3" rx="1.5" transform="rotate(45 13 10)" fill="#2346a0"/></svg>
          </button>
        </div>
      </div>
    </div>
    <div class="details-section">
      <div class="details-section-title">Class Details</div>
      <div><strong>Subject:</strong> ${data.subject}</div>
      <div><strong>Year Level:</strong> ${data.year_level}</div>
      <div><strong>Batch:</strong> ${data.batch}</div>
      <div><strong>Sub Batch:</strong> ${data.sub_batch || '‚Äî'}</div>
      <div><strong>Type:</strong> ${data.class_type || '‚Äî'}</div>
      <div><strong>Teacher:</strong> ${data.teacher || "Nisa Bandarayapa"}</div>
      <div style="display: flex; gap: 24px; align-items: center; margin-top: 4px;">
        <div><strong>Day:</strong> ${data.class_day || '‚Äî'}</div>
        <div><strong>Time:</strong> ${data.class_time || '‚Äî'}</div>
        <div><strong>Location:</strong> ${data.class_location || '‚Äî'}</div>
      </div>
      <div><strong>Description:</strong> <span title="${data.description || '‚Äî'}">${data.description || '‚Äî'}</span></div>
      <div><strong>Last Updated:</strong> ${melbourneTimeString(data.last_updated)}</div>
      <div><strong>Created:</strong> ${melbourneTimeString(data.class_created)}</div>
      <div><strong>Student Count:</strong> <em>Coming soon</em></div>
    </div>
    <div class="details-section">
      <div class="details-section-title">Google Classroom</div>
      ${data.gclass_linked ? `
        <div>
          <strong>Name:</strong>
          <a href="https://classroom.google.com/c/${data.courseId}" target="_blank" style="color:#2346a0; text-decoration:underline;">
            <span aria-label="Google Classroom">${data.classroom_name || data.class_name}</span>
            <span style="margin-left:6px;">üìö</span>
          </a>
        </div>
        <div><strong>Section:</strong> ${data.classroom_section || "‚Äî"}</div>
        <div><strong>Join Code:</strong> ${data.joinCode}</div>
      ` : `
        <button class="gclass-link-modern-btn" onclick="openGClassModal('${code}')">üìö Link to Classroom</button>
      `}
    </div>
    <div class="details-section">
      <div class="details-section-title">YouTube</div>
      <div>
        <strong>Playlist ID:</strong> ${
          data.playlist_id
            ? `<a href="https://www.youtube.com/playlist?list=${data.playlist_id}" target="_blank" style="color:#2346a0; text-decoration:underline;">${data.playlist_id}</a>`
            : '‚Äî'
        }
      </div>
    </div>
    `;
  // Dropdown menu logic
  const dropdownBtn = document.getElementById('details-dropdown-btn');
  const dropdownMenu = document.getElementById('details-dropdown');
  if (dropdownBtn && dropdownMenu) {
    dropdownBtn.onclick = function(e) {
      e.stopPropagation();
      dropdownMenu.style.display = dropdownMenu.style.display === 'block' ? 'none' : 'block';
    };
    document.addEventListener('click', function(e) {
      if (!dropdownMenu.contains(e.target) && e.target !== dropdownBtn) {
        dropdownMenu.style.display = 'none';
      }
    });
  }
  // Close pane logic
  const closeDetailsBtn = document.getElementById('close-details-pane-btn');
  if (closeDetailsBtn) {
    closeDetailsBtn.onclick = function() {
      resetDetailsPanel();
    };
  }
  // Wire up dropdown actions
  const editBtn = document.getElementById('dropdown-edit-class');
  if (editBtn) {
    editBtn.onclick = function() {
      dropdownMenu.style.display = 'none';
      openEditClassModal(code);
    };
  }
  const deleteBtn = document.getElementById('dropdown-delete-class');
  if (deleteBtn) {
    deleteBtn.onclick = function() {
      dropdownMenu.style.display = 'none';
      if (confirm('Are you sure you want to delete this class?')) {
        deleteClass(code);
      }
    };
  }
  const activeSwitch = document.getElementById('dropdown-active-switch');
  if (activeSwitch) {
    activeSwitch.onchange = function() {
      const newStatus = this.checked;
      if (!newStatus && !confirm("Are you sure you want to set this class as inactive?")) {
        this.checked = true;
        return;
      }
      fetch(`/edit_class/${code}`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({active: newStatus})
      }).then(() => location.reload());
    };
  }
}  

function resetDetailsPanel() {
  const panel = document.getElementById("class-details-panel");
  const placeholder = document.getElementById("class-details-placeholder");
  panel.classList.remove("active");
  panel.innerHTML = "";
  panel.style.display = "none";
  if (placeholder) placeholder.style.display = "flex";
}


function deleteClass(code) {
  if (!confirm("Are you sure you want to delete this class?")) return;
  fetch(`/delete_class/${code}`, {method: "POST"})
    .then(() => location.reload());
}



// Modal close on Escape
function closeDetailsPanel() {
  resetDetailsPanel();
}
document.addEventListener("keydown", function (e) {
  if (e.key === "Escape") {
    closeDetailsPanel();
    closeAllModals();
  }
});
// --- Pagination Logic ---
/* Removed unused: .class-name, .class-meta, .details-header, .details-tabs, .details-tab, .details-content, .details-actions */
// ...existing code...
function closeToast() {
  const toast = document.getElementById("toast-message");
  if (toast) toast.style.display = "none";
}
// Auto-hide after 4 seconds and reload after Add Class form submit
window.addEventListener("DOMContentLoaded", function() {
  const toast = document.getElementById("toast-message");
  if (toast) setTimeout(() => toast.style.display = "none", 4000);

  // Ensure Add Class form reloads page after submit
  const addClassForm = document.querySelector('#add-class-modal form');
  if (addClassForm) {
    addClassForm.addEventListener('submit', function() {
      setTimeout(() => location.reload(), 800);
    });
  }
});
function openEditClassModal(code) {
  closeAllModals();
  const data = classData[code];
  document.getElementById("edit-subject").value = data.subject || "";
  document.getElementById("edit-year-level").value = data.year_level || "";
  document.getElementById("edit-batch").value = data.batch || "";
  document.getElementById("edit-sub-batch").value = data.sub_batch || "";
  document.getElementById("edit-class-type").value = data.class_type || "Group";
  document.getElementById("edit-description").value = data.description || "";
  document.getElementById("edit-teacher").value = data.class_teacher || "";
  document.getElementById("edit-class-day").value = data.class_day || "Monday";
  document.getElementById("edit-class-time").value = data.class_time || "";
  document.getElementById("edit-class-location").value = data.class_location || "";
  document.getElementById("edit-class-modal").style.display = "block";
  document.getElementById("modal-overlay").style.display = "block";
  document.getElementById("edit-class-form").onsubmit = function(e) {
    e.preventDefault();
    // AJAX POST to backend
    fetch(`/edit_class/${code}`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({
        subject: document.getElementById("edit-subject").value,
        year_level: document.getElementById("edit-year-level").value,
        batch: document.getElementById("edit-batch").value,
        sub_batch: document.getElementById("edit-sub-batch").value,
        class_type: document.getElementById("edit-class-type").value,
        description: document.getElementById("edit-description").value,
        class_teacher: document.getElementById("edit-teacher").value,
        class_day: document.getElementById("edit-class-day").value,
        class_time: document.getElementById("edit-class-time").value,
        class_location: document.getElementById("edit-class-location").value
      })
    })
    .then(response => response.json())
    .then(result => {
      if (result.status === "success") {
        showToast("Class updated successfully!", "success");
        // Optionally update classData and UI in-place here
        closeEditClassModal();
        setTimeout(() => location.reload(), 1200);
      } else {
        showToast(result.message || "Failed to update class.", "error");
      }
    })
    .catch(() => {
      showToast("Failed to update class.", "error");
    });
  };
// Toast feedback utility
function showToast(message, category) {
  const toast = document.createElement("div");
  toast.className = `toast-message toast-${category}`;
  toast.innerHTML = `<span class="toast-icon">${category === 'success' ? '‚úÖ' : category === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span><span class="toast-text">${message}</span><button class="toast-close" onclick="this.parentElement.remove()">&times;</button>`;
  document.body.appendChild(toast);
  setTimeout(() => { if (toast.parentElement) toast.remove(); }, 3500);
}
}
function closeEditClassModal() {
  document.getElementById("edit-class-modal").style.display = "none";
  document.getElementById("modal-overlay").style.display = "none";
}

// --- Google Classroom Link Modal Logic ---
let gclassLinkCode = null;
function openGClassModal(code) {
  closeAllModals();
  gclassLinkCode = code;
  const data = classData[code];
  document.getElementById("gclass-link-modal").style.display = "block";
  document.getElementById("modal-overlay").style.display = "block";
  // Autofill name
  document.getElementById("gclass-link-name").value = data.gclass_name || data.class_name || getClassName(data.subject, data.year_level, data.batch, data.sub_batch);
  document.getElementById("gclass-link-section").value = data.gclass_section || "";
}
function closeGClassModal() {
  document.getElementById("gclass-link-modal").style.display = "none";
  document.getElementById("modal-overlay").style.display = "none";
}

// Handle Google Classroom link form submit (AJAX)
document.addEventListener("DOMContentLoaded", function() {
  const gclassForm = document.getElementById("gclass-link-form");
  if (gclassForm) {
    let submitting = false;
    gclassForm.addEventListener("submit", function(e) {
      e.preventDefault();
      if (submitting) return;
      submitting = true;
      const submitBtn = gclassForm.querySelector('button[type="submit"]');
      if (submitBtn) submitBtn.disabled = true;
      const name = document.getElementById("gclass-link-name").value.trim();
      const section = document.getElementById("gclass-link-section").value.trim();
      if (!gclassLinkCode) {
        showToast("No class selected for linking.", "error");
        if (submitBtn) submitBtn.disabled = false;
        submitting = false;
        return;
      }
      fetch(`/api/link_google_classroom/${gclassLinkCode}`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({gclass_name: name, gclass_section: section})
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === "success") {
          showToast(data.message || "Google Classroom linked!", "success");
          // Wait for user to see feedback, then close modal and reload
          setTimeout(() => {
            closeGClassModal();
            setTimeout(() => location.reload(), 800);
          }, 1200);
        } else {
          showToast(data.message || "Failed to link Classroom.", "error");
          if (submitBtn) submitBtn.disabled = false;
          submitting = false;
        }
      })
      .catch(err => {
        showToast("Network error. Please try again.", "error");
        if (submitBtn) submitBtn.disabled = false;
        submitting = false;
      });
    });
  }
});

document.getElementById("modal-overlay").addEventListener("click", closeAllModals);

document.addEventListener("keydown", function (e) {
  if (e.key === "Escape") {
    closeDetailsPanel();
    closeAllModals();
  }
});
// --- Melbourne timezone conversion helper ---
function melbourneTimeString(dateStr) {
  if (!dateStr) return '‚Äî';
  try {
    // Always parse as UTC and convert to Melbourne
    let date;
    if (dateStr.endsWith('Z')) {
      date = new Date(dateStr);
    } else if (dateStr.includes('T')) {
      date = new Date(dateStr + 'Z');
    } else {
      date = new Date(dateStr);
    }
    return date.toLocaleString('en-AU', { timeZone: 'Australia/Melbourne', hour12: false });
  } catch {
    return dateStr;
  }
}

// Initial render
// --- Pagination Logic ---
let currentPage = 1;
const pageSize = 10;
let filteredCodes = Object.keys(classData);

function renderTablePage() {
  const tbody = document.querySelector('#classes-table tbody');
  tbody.innerHTML = '';
  // Pagination
  const totalRecords = filteredCodes.length;
  const totalPages = Math.max(1, Math.ceil(totalRecords / pageSize));
  if (currentPage > totalPages) currentPage = totalPages;
  const startIdx = (currentPage - 1) * pageSize;
  const endIdx = Math.min(startIdx + pageSize, totalRecords);
  for (let i = startIdx; i < endIdx; i++) {
    const code = filteredCodes[i];
    const data = classData[code];
    const tr = document.createElement('tr');
    tr.className = 'class-row';
    tr.onclick = () => showClassDetails(code);
    tr.innerHTML = `
      <td class="class-name-link">${code}</td>
      <td>${data.subject}</td>
      <td>${data.year_level}</td>
      <td>${data.batch}</td>
      <td><span class="status-indicator ${data.active !== false ? 'active' : 'inactive'}">${data.active !== false ? 'Active' : 'Inactive'}</span></td>
      <td>${data.courseId ? '<span class="linked-symbol">&#10003;</span>' : ''}</td>
    `;
    tbody.appendChild(tr);
  }
  renderTableFooter(totalRecords, totalPages);
}

function renderTableFooter(totalRecords, totalPages) {
  const footer = document.getElementById('table-footer');
  let pageBtns = '';
  for (let p = 1; p <= totalPages; p++) {
    pageBtns += `<button class="page-btn${p === currentPage ? ' active' : ''}" onclick="gotoPage(${p})">${p}</button>`;
  }
  footer.innerHTML = `
    <span>Records: ${totalRecords}</span>
    <span>Page: ${pageBtns}</span>
    <span>Showing ${totalRecords === 0 ? 0 : ((currentPage-1)*pageSize+1)}-${Math.min(currentPage*pageSize, totalRecords)} of ${totalRecords}</span>
  `;
}

function gotoPage(page) {
  currentPage = page;
  renderTablePage();
}

renderTablePage();
// Hide details panel on load
window.addEventListener('DOMContentLoaded', function() {
  document.getElementById('class-details-panel').style.display = 'none';
});
</script>
{% endblock %}